
# デプロイ設計書（Webアプリ：tusd + ASP.NET + UI + PostgreSQL）

作成日: 2025-12-28

本書は、LAN内サーバーで「録画セグメントの受信（tus/tusd）→検索/配信（Web API）→UI提供（同一オリジン）→日次アーカイブ（ADLS）→ローカル7日保持」を運用するための、最小構成のデプロイ設計を定義する。

> 注意: 現時点のリポジトリには Web 実装（ASP.NET プロジェクトや Vite UI）が未配置のため、本書は「実装が揃った時にそのまま載せられる」構成を先に確定する目的で記載している。

---

## 1. 目的 / スコープ
### 1.1 目的
- LAN内の単一サーバー（1ホスト）で最小の運用負荷で稼働させる
- UI と API を同一オリジンで提供し、CORSを避ける
- tusd の受信口は前段のリバースプロキシで最低限の防御（IP制限・簡易認証・サイズ上限等）を適用する

### 1.2 対象
- 本番（LAN内）デプロイ
- 開発（ローカル）デプロイ（最小の再現性）

### 1.3 対象外
- 公開インターネット前提の運用（WAF/ゼロトラスト/多要素認証等）
- Kubernetes 等のオーケストレーション（過剰な運用コストを避ける）

---

## 2. 前提 / 制約（要点）
- UI と API は同一オリジンで提供する（例: `http://<Server IP>:8080/`）
- 動画は MP4（H.265 + AAC）を基本とし、UIは再生不可でもダウンロード導線を必ず持つ
- `/api/segments/{segmentId}/stream` は HTTP Range 対応（`206 Partial Content`）を必須寄り（MVPで実装）
- ローカル保持は `receivedAt`（サーバー受信時刻）基準で原則7日
- ADLS への日次アーカイブを行い、ローカル削除後も配信が成立する（ローカル優先→ADLSフォールバック）

---

## 3. 推奨デプロイ方式（結論）
### 3.1 本番: Docker Compose（単一ホスト）
本システムの本番デプロイは Docker Compose を推奨する。

理由:
- tusd / Web API / DB / 永続ボリュームの一体運用を標準化でき、環境差分を最小化できる
- UI と API の同一オリジン提供を、リバースプロキシで安定して実現できる
- 起動/停止/更新/ログ収集が単純で、LAN内運用の「最小スコープ」に適合する

### 3.2 開発: 「依存サービスは Compose、アプリはホスト」も許容
macOS の Docker ファイル監視（`dotnet watch` / Vite dev server）が重い場合があるため、開発では次の折衷を許容する。

- Compose: `postgres` / `tusd` / `reverse-proxy`（必要なら）
- ホスト: ASP.NET（`dotnet watch run`）、UI（`npm run dev`）

---

## 4. 物理/論理構成

### 4.1 コンテナ構成（最小）
- `reverse-proxy`（推奨: nginx）
	- 外部公開の入口（UI / API / tus を同一オリジンで提供）
	- IP allowlist、`X-Api-Key` 等の簡易認証、サイズ制限、タイムアウト等の適用点
- `webui`（nginx + Vite build）
	- UI静的配信（SPA fallback を含む）
- `webserver`（ASP.NET）
	- Web API（`/api/*`）
	- tusd フック受信（UploadCompleted）
	- 日次ジョブ（ADLSアーカイブ、7日削除）※HostedService/スケジューラ等で実装
- `postgres`
	- メタデータ永続化（works/segments）
- `tusd`
	- tus 受信（再開可能アップロード）
	- 完了フックで `webserver` に通知

### 4.2 ネットワーク/入口
外部公開するポートは最小化する。

- `8080/tcp`: UI + API（同一オリジン）
- `1080/tcp`: tus受信（Androidからのアップロード）
	- 可能であれば `1080` も `reverse-proxy` 経由に統合し、tusd を直接公開しない

### 4.3 論理フロー（概要）
```mermaid
flowchart LR
	A[Android] -->|tus upload| RP[reverse-proxy]
	RP --> T[tusd]
	T -->|hook: upload completed| W[webserver (ASP.NET)]
	W --> DB[(PostgreSQL)]
	U[Browser] -->|UI + /api| RP
	RP --> UI[webui]
	RP --> W
	W -->|read local| FS[(local videos)]
	W -->|fallback| ADLS[(ADLS)]
```

---

## 5. ディレクトリ/永続化（ホスト上）
### 5.1 推奨配置（例）
- `/srv/uvccamera-web/`
	- `compose/`（`docker-compose.yml`、nginx設定等）
	- `env/`（`.env` 等の設定ファイル。リポジトリ管理しない）
	- `data/`（永続ボリュームのマウント先）
		- `postgres/`
		- `tusd/`
		- `videos/`（受信済み動画のローカル置き場）
		- `logs/`（必要なら）

### 5.2 保持方針
- ローカル動画は `receivedAt` 基準で原則7日
- 7日削除の前提として「ADLSに存在（または参照可能）」を満たす（運用判断で例外は削除しない）

容量設計（目安の決め方）:
- 最大同時端末数 × 平均ビットレート × 7日分 + バッファ（運用上の余裕）
- 7日保持は運用上固定のため、ディスク枯渇対策として**サイズ上限/レート制限**は必須寄り

---

## 6. 設定（環境変数/シークレット）
### 6.1 方針
- すべて環境変数（または `.env`）で与え、イメージに焼き込まない
- `.env` はリポジトリにコミットしない
- 可能なら Docker secrets（またはホストの権限分離）を利用する

### 6.2 主要パラメータ（例）

#### 6.2.1 `webserver`（ASP.NET）
- `ASPNETCORE_URLS=http://0.0.0.0:8080`
- `ConnectionStrings__Main=Host=postgres;Port=5432;Database=uvc;Username=...;Password=...`
- `Storage__LocalRoot=/data/videos`
- `Tus__HookApiKey=...`（tusdフックの正当性確認に使う場合）
- `Security__ApiKey=...`（Android/運用用の `X-Api-Key`）
- `Security__AllowedUploadCidrs=...`（IP allowlistをアプリ側で持つ場合）

ADLS（実装時に確定）:
- `Adls__Enabled=true|false`
- `Adls__AccountUrl=https://<account>.dfs.core.windows.net/`
- `Adls__FileSystem=<container>`
- 認証情報（例: Service Principal）
	- `Azure__TenantId=...`
	- `Azure__ClientId=...`
	- `Azure__ClientSecret=...`

#### 6.2.2 `tusd`
- `TUSD_DATA_DIR=/data/tusd`
- `TUSD_UPLOAD_DIR=/data/videos/incoming`
- `TUSD_HOOK_HTTP_URL=http://webserver:8080/api/tusd/hooks/completed`（例）
- `TUSD_HOOK_HTTP_HEADER_X_API_KEY=...`（例）

#### 6.2.3 `reverse-proxy`（nginx）
- 最大サイズ（例: `client_max_body_size`）
- タイムアウト（アップロード/ストリーミングを考慮）
- IP allowlist
- `X-Api-Key` の検証（運用要件により）

---

## 7. Docker Compose（設計例）
実装が揃った段階で、次のような構成を基本形とする。

```yaml
services:
	reverse-proxy:
		image: nginx:stable
		ports:
			- "8080:8080"   # UI + API
			- "1080:1080"   # tus (推奨: ここもproxy経由)
		depends_on:
			- webui
			- webserver
			- tusd
		volumes:
			- ./nginx.conf:/etc/nginx/nginx.conf:ro
		networks: [appnet]

	webui:
		image: <registry>/uvccamera-webui:<tag>
		networks: [appnet]

	webserver:
		image: <registry>/uvccamera-webserver:<tag>
		environment:
			- ASPNETCORE_URLS=http://0.0.0.0:8080
			- ConnectionStrings__Main=Host=postgres;Port=5432;Database=uvc;Username=...;Password=...
			- Storage__LocalRoot=/data/videos
		volumes:
			- /srv/uvccamera-web/data/videos:/data/videos
		depends_on: [postgres]
		networks: [appnet]

	tusd:
		image: tusproject/tusd:latest
		command: [
			"-upload-dir=/data/videos/incoming",
			"-base-path=/files/",
			"-hooks-http=http://webserver:8080/api/tusd/hooks/completed"
		]
		volumes:
			- /srv/uvccamera-web/data/tusd:/data/tusd
			- /srv/uvccamera-web/data/videos:/data/videos
		networks: [appnet]

	postgres:
		image: postgres:16
		environment:
			- POSTGRES_DB=uvc
			- POSTGRES_USER=uvc
			- POSTGRES_PASSWORD=...  # secret推奨
		volumes:
			- /srv/uvccamera-web/data/postgres:/var/lib/postgresql/data
		networks: [appnet]

networks:
	appnet:
```

ポイント:
- `postgres` / `tusd` は外部公開しない
- `reverse-proxy` で UI/API/tus の入口を制御する（IP制限・認証・サイズ制限）
- `videos` は `webserver` と `tusd` で共有する（受信→確定→配信）

---

## 8. 起動/停止/更新手順（本番）
### 8.1 初回セットアップ
1) サーバーに Docker Engine / Docker Compose を導入
2) 永続ディレクトリを作成（例: `/srv/uvccamera-web/data/...`）
3) `.env` を作成（DBパスワード、APIキー、ADLS資格情報等）
4) `docker compose up -d`
5) 動作確認（下記のチェックリスト）

### 8.2 更新（ローリングの最小）
1) 新しいイメージを取得（`docker compose pull`）またはビルド
2) `docker compose up -d`（差分のみ再作成）
3) 失敗時は直前タグへ戻す（イメージタグを戻して再実行）

DBマイグレーションが必要な場合:
- `webserver` 起動時に自動適用するか、別途 `migrate` ジョブとして一回実行する（実装で確定）

---

## 9. 運用（ログ/バックアップ/監視）
### 9.1 ログ
- 基本は `docker logs` に集約
- 長期保管が必要なら、ホスト側へログを出す（またはログドライバ/収集基盤）

最低限の確認:
- `tusd` の開始/完了/失敗
- `webserver` の例外ログ（`segmentUuid/segmentId/workId` 等の相関情報）

### 9.2 バックアップ
- `postgres` は定期的に `pg_dump`（またはボリュームスナップショット）
- ローカル動画は原則「一時保持」で、ADLSが正本になる想定（運用方針で調整）

### 9.3 監視（最小）
- ディスク使用率（枯渇は致命）
- コンテナ死活（`webserver` / `tusd` / `postgres`）
- エラー率（API 5xx、tusd失敗）

---

## 10. セキュリティ（LAN内の最低限）
- tusd は直接公開せず、前段 `reverse-proxy` 配下に置く
- IP allowlist（許可端末のみ）
- `X-Api-Key` 等の簡易認証（内部誤送信・想定外端末の事故対策）
- サイズ上限（1ファイル/合計）と同時接続/レート制限（容量枯渇・帯域枯渇の予防）
- DB は外部へ公開しない（同一 Docker network 内のみ）

---

## 11. 受入/動作確認チェックリスト
- UIが `http://<Server IP>:8080/` で表示できる
- `GET /api/works` が応答する（空でもよい）
- tusアップロードが成功し、完了フックが `webserver` に到達する
- `GET /api/works/{workId}` がセグメント一覧を `recordedAt` 昇順で返す
- `GET /api/segments/{segmentId}/download` がファイルダウンロードできる
- `GET /api/segments/{segmentId}/stream` が Range ありで `206` を返す（シーク可能）
- ローカルに無い場合でもADLSフォールバックで download/stream が成立する（ADLS有効時）

---

## 12. 未確定事項（実装で確定する）
- `webserver` の実装言語/フレームワーク確定（本書は ASP.NET を前提）
- UI 静的配信の方式（ASP.NET 内蔵配信 / nginx配信 / 両方の役割分担）
- DB マイグレーション方針（起動時自動/手動ジョブ）
- tusd フックの形式（HTTP hook のペイロード、認証ヘッダ、再送時挙動）
- ADLS 認証方式（Service Principal / Managed Identity 等）

