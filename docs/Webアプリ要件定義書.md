
# Webアプリ要件定義書

## 1. 目的
Androidアプリ（UVCCameraDemo）からLAN内サーバーへアップロードされた録画セグメントを、PC等のブラウザから検索・閲覧（再生/ダウンロード）できるWebアプリを提供する。

## 2. スコープ
### 2.1 対象
- Androidアプリからのアップロード受信（動画ファイル＋作業メタデータ、レジューム可能）
- Androidアプリ向け工程マスタ提供（工程候補の取得）
- アップロード済み動画（録画セグメント）の検索
- 作業単位（workId/model/serial/process）での一覧・詳細表示
- 動画の再生（ブラウザ内）およびダウンロード
- ADLS（Azure Data Lake Storage）への日次アップロード（アーカイブ）およびADLS上動画の再生/ダウンロード

### 2.2 対象外
- 動画編集、コメント、アノテーション
- ライブ配信
- 公開インターネット向けの運用
- Webブラウザからの手動アップロード

## 3. 前提/制約
- 利用環境はLAN内を想定する
- サーバーに保存される動画は、Android側で作業単位に紐づけられた録画セグメントを基本とする（未割当は基本的にアップロードされない）
- サーバーはADLSへ接続できる（LAN内からのアウトバウンド許可、または閉域/プロキシ等で到達可能）
- 動画形式はMP4（H.265 + AAC）を基本とする
	- ブラウザで再生できない環境があり得るため、その場合でもダウンロードにより視聴できること
- アップロード受信は再開可能アップロード方式（レジューム可能）とし、Androidアプリが採用する方式と互換であること
- ブラウザがADLSへ直接アクセスすることを要件としない（ADLS上動画の閲覧はWebアプリ/サーバー側の提供で成立すること）
- 認証/認可は運用で必要性を判断する（LAN内前提で、必要なら追加可能とする）

## 4. 用語
- 作業: 組み立て等の作業単位（開始〜終了までを1作業として扱う）
- 作業ID（workId）: 1つの作業（開始〜終了まで）を一意に識別するID。端末側で作業開始時に発行され、サーバーへ送信される。
- model: 型式
- serial: 機番
- process: 工程
- 録画セグメント: 一定間隔/作業操作で分割された録画ファイル単位。
- recordedAt: セグメントの撮影日時。検索/保持期間/アーカイブの基準となる。
- segmentIndex: 同一workId内の順序を表す値。

## 5. データ要件
### 5.1 受信メタデータ
受信時に、動画と紐づく作業メタデータを受け取り、検索可能な形で保持できること。

- 必須: segmentUuid, workId, model, serial, process, segmentIndex, recordedAt
- 任意: durationSec

補足:
- segmentUuid は端末がセグメント生成時に発行する不変ID（UUID）であり、重複受信（再送）・後追い紐づけ・segmentIndex再採番が発生しても同一セグメントを一意に識別できること。

### 5.2 recordedAt の一貫性
recordedAt は検索/保持期間の基準となるため、Android→サーバー→ADLS→Web UI で同一の表現・タイムゾーンで扱えること。

### 5.3 segmentIndex の解釈
segmentIndex は同一workId内の順序を表す値として扱えること。

補足:
- segmentIndex は後追い紐づけ等により再採番され得るため、「同一セグメント」の識別は segmentUuid を正とする。

## 6. 機能要件
### 6.1 受信（アップロード）
- Androidアプリから送信される動画ファイル（録画セグメント）を受信できる
- 通信断等が発生しても、受信済みオフセットから再開できる（レジューム可能）
- 受信した動画に対し、作業紐づけ用メタデータを受信・保存できる
- 受信完了後、Webアプリの検索/一覧/再生/ダウンロードで参照できる状態になる
- 同一セグメントの再送（重複受信）が発生しても、参照側（検索/一覧/詳細/再生/ダウンロード）が破綻しないこと

### 6.2 一覧（検索）
- 作業単位の一覧を表示できる
- 検索条件として以下を指定できる
	- 作業ID（完全一致）
	- 型式（model、部分一致可）
	- 機番（serial、部分一致可）
	- 工程（process、部分一致可）
	- 日付（recordedAtの期間）
- 検索結果は作業単位で表示し、作業内の録画セグメント数・期間等の概要を確認できる

### 6.3 作業詳細（セグメント一覧）
- 作業を選択すると、その作業に紐づく録画セグメント一覧を表示できる
- セグメント一覧には少なくとも以下を表示できる
	- recordedAt（撮影日時）
	- segmentIndex（セグメント番号）
	- ファイル名（または識別子）
	- ファイルサイズ（取得可能な場合）

### 6.4 再生
- セグメントを選択して再生できる
- 再生/一時停止/シーク等の基本操作を提供する
- ブラウザで再生できない場合でも、クラッシュせず「再生不可」を明示できる

### 6.5 ダウンロード
- セグメント動画をファイルとしてダウンロードできる

### 6.6 エラーハンドリング
- 動画が存在しない/参照できない場合、ユーザーに分かるメッセージを表示する
- サーバーエラー時、再試行を促すメッセージを表示する

### 6.7 アーカイブ（ADLS連携）
- サーバー上の受信済み動画を、ADLSへ毎日1回アップロードできる
	- 対象は当日分に限定せず、未アップロード分があれば再試行できること
- ADLS上の動画も、Webアプリから再生/ダウンロードできること（ローカルに存在しない場合のフォールバックを含む）

### 6.8 保持/削除（ローカル）
- ローカル（サーバー）に保存された動画は、原則としてrecordedAtから7日を超えたものを削除できる（自動）
	- 削除後も、WebアプリからはADLS上の動画を参照して再生/ダウンロードできること

### 6.9 工程マスタ提供（Android向け）
- Androidアプリが作業開始時に選択する「工程候補」を取得できるWeb APIを提供できる
	- 工程候補は一覧として取得できること
	- LAN内運用を前提とし、認証/認可は運用で必要性を判断する（必要なら後から追加可能）

## 7. 非機能要件
### 7.1 性能
- 一覧表示/検索は実用的な時間（数秒程度）で応答することを目標とする

### 7.2 信頼性
- サーバー側で一時的なエラーが発生しても、Webアプリが致命的に停止しないこと

### 7.3 セキュリティ
- LAN内利用を前提とする
- 認証/認可が必要な場合、後から追加できること

### 7.4 互換性
- 対象ブラウザは運用で定める

## 8. 画面要件（最小）
- 一覧/検索画面: 検索条件入力、作業一覧
- 作業詳細画面: セグメント一覧、セグメント選択
- 再生画面: 動画プレイヤー、ダウンロード

## 9. 受入条件
- 再開可能アップロードで動画ファイルを受信でき、通信断があっても再開できる
- 受信した動画に作業メタデータが紐づいて保存される
- 作業ID/model/serial/process/日付を条件に、アップロード済み作業を検索できる
- 作業詳細でセグメント一覧を確認できる
- セグメントを再生できる（再生不可な環境ではダウンロードにより視聴できる）
- 存在しない動画/サーバーエラー時に適切なエラー表示がされる
- サーバーが毎日ADLSへ動画をアップロードできる
- ローカルの動画が7日を超えたら削除されても、ADLS上の動画を再生/ダウンロードできる
- Androidアプリが工程候補（工程マスタ）をWeb APIから取得できる

