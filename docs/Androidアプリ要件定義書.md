---
title: Androidアプリ要件定義書
date: 2025-12-28
---

# 要件定義書（Android：UVC録画・作業紐づけ・自前サーバーアップロード）

## 1. 目的
UVC対応USBカメラを利用し、Android端末上で以下を提供する。

- 低遅延なプレビュー表示
- 常時録画（セグメント生成）と作業（型式/機番/工程）への紐づけ
- 録画一覧（作業単位のグルーピング、未割当の確認/救済）
- 録画ファイルの端末内再生
- 作業に紐づく録画セグメントの自前サーバーへの自動アップロード（Wi‑Fi限定、再開可能）
- 端末の最小空き容量を確保するための未割当セグメント自動削除

## 2. スコープ
### 2.1 対象（本フェーズ）
- UVC接続/許可取得/切断時制御
- プレビュー開始/停止
- 常時録画（セグメント生成）とセグメント分割
- 作業情報の入力・作業開始/中断/再開/終了
- 録画一覧（作業単位でグルーピング、未割当も表示）
- 未割当セグメントの後追い紐づけ（救済）
- セグメント再生（端末内）
- 未割当の自動削除（閾値未達時は録画停止＋通知）
- 自前サーバー（LAN）への自動アップロード（Wi‑Fi限定、再開可能）

### 2.2 対象外（本フェーズ）
- 一般クラウドサービス連携（SaaS等）
- 動画編集、ライブ配信
- サーバー側での動画検索/再生（閲覧UI/視聴機能）

## 3. 前提/制約
- Android端末がUSB OTGに対応していること
- 対応OS: Android 7.0（API 24）以上
- UVC準拠のUSBカメラを使用すること
- 対応解像度/フレームレート
	- 必須: 640x480@30fps
	- 対応（カメラ/端末が対応している場合）: 1280x720@30fps / 1920x1080@30fps
- 基本機能（プレビュー/録画/再生）はオフライン動作可能であること
- アップロードはWi‑Fi接続時のみ実行（モバイル回線では実行しない）
- アップロード先はLAN内の自前サーバーを想定し、接続先は設定で変更できること
- 録画形式: MP4（H.265/HEVC + AAC）を基本とする
	- 端末がH.265再生に非対応の場合があるため、再生不可時はクラッシュせず「再生不可」を明示する
	- WebブラウザのH.265非対応による運用負荷を下げるため、H.264（AVC）で録画できる「互換モード」を提供する（設定で切替可能）
		- 互換モードはアプリの設定項目として提供する
		- 既定（初期値）は H.265（高圧縮）
		- 再生互換性を優先したい場合は H.264 を選択できる

## 4. 用語
- 作業: 開始〜終了までを1単位として扱う
- 作業ID（workId）: 作業を一意に識別するID（例: UUID）
- セグメント不変ID（segmentUuid）: 端末が録画セグメント生成時に発行する不変ID（UUID）。後追い紐づけやsegmentIndex再採番が行われても変化しない。
- 録画セグメント: 分割単位となる録画ファイル
- 未割当セグメント: 作業IDに紐づいていないセグメント
- 割当済みセグメント: 作業IDに紐づくセグメント

## 5. 機能要件

### 5.1 カメラ接続/認識
- UVCカメラ接続時に認識し、利用許可を促す
- 未接続時は案内を表示する
- 接続解除時はプレビュー/録画を停止し、ユーザーに通知する（録画中は可能な範囲でファイルを確定する）

### 5.2 権限/プライバシー
- 必要な権限
	- USBデバイス利用許可（UVC）
	- カメラ（QRコード読み取りのため）
	- 録音（音声を含む録画のため）
	- インターネット（アップロードのため）
- 録画ファイルは端末内（アプリ専用領域）に保存し、ユーザーが指定した自前サーバー以外へは送信しない

### 5.3 プレビュー表示
- カメラ映像を低遅延で表示する
- 画面回転時も適切な向き/アスペクト比で表示する
- プレビューの開始/停止をユーザー操作で行える

### 5.4 録画（常時録画＋セグメント）
#### 5.4.1 録画の基本
- プレビュー中にセグメント生成（録画）を実行できる
- 録画は映像+音声を含む
- 録画中は状態表示（録画中インジケータ、経過時間）を行う
- 録画停止後、ファイルを保存し一覧に反映する
- 録画中のエラー（ストレージ不足、切断など）を通知する

#### 5.4.2 常時録画（バッファ）の開始/停止条件
- 常時録画（セグメント生成）は「プレビュー開始中」かつ「UVC接続中」の間に行う
- プレビュー停止、またはUSB切断で録画を停止する

#### 5.4.3 セグメント分割ルール
- セグメントは以下のタイミングで必ず分割される
	1) 一定間隔（設定可能）
	2) 作業操作（開始/中断/再開/終了）
	3) USB切断や録画エラー発生時（可能な範囲で確定して終了）
- 一定間隔は設定で変更できる（初期値5分、設定範囲1〜10分）
	- 設定変更は「次セグメントから」適用する（現在録画中のセグメント長は変更しない）

#### 5.4.4 作業連動の録画制御

本アプリにおける作業開始は、以下を満たしたタイミングで成立する。

- 型式/機番: 作業指示書のQRコードから取得できていること
- 工程: Web APIから取得した工程マスタから選択できていること
- 作業開始トリガ: 「音声指示（作業開始）」または「作業開始ボタン」のいずれかで開始を確定すること

作業開始は、上記の「QRコード読み取り（型式/機番の取得）」と「作業開始トリガ」が両方揃った時点でのみ成立する。

また、作業中断/再開/終了も「音声指示」または「ボタン」で実行できる。

- 作業開始
	- QRコードから型式/機番を取得し、工程を選択して確定する
	- 作業開始トリガ（音声指示またはボタン）で作業開始を確定し、作業ID（workId）を発行する
	- 以降に確定するセグメントは作業IDに紐づく（割当済み）
	- 操作時にセグメント境界を切る
- 作業中断
	- 以降に確定するセグメントは未割当とする
	- 「音声指示」または「ボタン」で中断できる
	- 操作時にセグメント境界を切る
- 作業再開
	- 以降に確定するセグメントは同一workIdへ紐づく
	- 「音声指示」または「ボタン」で再開できる
	- 操作時にセグメント境界を切る
- 作業終了
	- 以降に確定するセグメントは未割当とする
	- 「音声指示」または「ボタン」で終了できる
	- 操作時にセグメント境界を切る
- 同一作業IDに複数セグメントが紐づくこと（中断/再開で増える）を前提とする

#### 5.4.4.1 ワーク切替時の扱い
- あるワークの作業が進行中（ACTIVEまたはPAUSED）の状態で、別ワークの作業開始が成立した場合
  - 前のワークの作業を自動的に終了する（作業終了扱い）
  - その後、次のワークの作業を開始する
  - いずれの操作でもセグメント境界が明確になるよう分割する

#### 5.4.5 後追い紐づけ（救済）
- 未割当セグメントを後から作業IDに紐づけ直せる
- 後追い紐づけ後のセグメントはアップロード対象となる

#### 5.4.6 作業情報の取得（QRコード＋Web API）
- 型式/機番は、ワークに付与された作業指示書のQRコードを読み取り取得する
	- QRコード読み取りは端末のカメラで行う
	- 取得できるまで作業開始はできない
- 工程は、Web APIから取得する（工程マスタ）
	- 工程候補（工程マスタ）をWeb APIから取得し、その中からユーザーが選択する
	- 選択した工程は端末内に「設定」として保存し、次回起動時に復元される
		- 復元した工程が最新の工程候補に存在しない場合は未選択扱いに戻し、再選択を促す
	- Web APIに接続できない場合は、工程候補を取得できず工程が確定できないため作業開始できない（理由を明示する）
- 作業開始の確定は「音声指示」または「ボタン」で行う
	- 音声指示が利用できない場合でもボタンで開始できる
	- 作業開始は「QRコード読み取り」と「作業開始トリガ」が両方揃って初めて成立する

作業中断/再開/終了:
- いずれも「音声指示」または「ボタン」で実行できる

### 5.5 録画ファイル一覧
- 録画済みファイルを一覧表示する
- 作業単位でグルーピングし、作業内セグメント一覧を確認できる
- 未割当セグメントも一覧で確認できる
- 並び順
	- 作業一覧: 作業開始日時の新しい順
	- 作業内セグメント: 録画日時の古い順（時系列）

### 5.6 再生
- 録画ファイルを端末内で再生できる
- 再生/一時停止/シーク等の基本操作を提供する
- 全画面表示への切り替え/解除ができる
- 画面回転時も再生を継続する
- 再生不可（端末非対応/ファイル破損等）の場合、クラッシュせずユーザーに明示する

### 5.7 削除（自動）
- ユーザー操作による削除は提供しない

空き容量が閾値を下回った場合は、以下の優先順位で古いものから自動削除する。

1. 未割当セグメント（作業IDに紐づかない）
2. アップロード済みセグメント（作業IDに紐づく/紐づかないを問わない）

	- 未アップロードの割当済みセグメントは削除しない
	- 閾値は設定で変更できる（初期値は運用で定める）
- 未割当削除後も閾値を満たせない場合
	- ユーザーに通知する
	- 録画（セグメント生成）を停止する（継続不可能であることを明示する）

### 5.8 アップロード（自前サーバー、再開可能）
- 割当済みセグメント（作業IDに紐づく）を自動アップロードできる
- 未割当セグメントはアップロードしない
- 後追い紐づけされたセグメントはアップロード対象となる
- 実行条件
	- Wi‑Fi接続時のみ実行する
	- 失敗時は自動リトライし、Wi‑Fi再接続後に再開できる
- 方式
	- 再開可能アップロード（tus、または同等方式）
- 送信メタデータ（最低限）
	- segmentUuid, workId, model, serial, process, segmentIndex, recordedAt

補足:
- segmentIndex は後追い紐づけ等で再採番され得るため、サーバー側での「同一セグメント」識別・冪等処理・重複判定・ログ相関の中心は segmentUuid とする。

補足:
- アップロード済みセグメントは、端末空き容量確保のため自動削除の対象となる

## 6. 非機能要件
### 6.1 性能
- プレビュー開始までの時間は実用的な範囲（数秒以内を目標）
- 連続録画中に大きなフレーム落ちが発生しないこと

### 6.2 信頼性
- 予期せぬ切断時もアプリがクラッシュしないこと
- 録画中断時は可能な範囲でファイルを保全する
- アップロード中の通信断/サーバー一時停止が発生しても再開可能であること

### 6.3 互換性
- 対応OSバージョン: Android 7.0（API 24）以上
- 対応カメラはUVC準拠に限定する

### 6.4 使いやすさ
- 主要操作（作業開始/中断/再開/終了、一覧、再生）は1タップで到達できる
- エラー時は分かりやすいメッセージを表示する

## 7. 画面要件（最小）
- メイン画面: プレビュー表示、作業情報（型式/機番/工程）の入力、作業開始/中断/再開/終了ボタン、録画一覧への導線
- 一覧画面: 作業単位の一覧、作業内セグメントの一覧、未割当セグメントの一覧、後追い紐づけの操作
- 再生画面: 動画プレイヤーと基本操作、全画面切替

## 8. データ要件
- 録画ファイルは端末内（アプリ専用領域）に保存する
- 録画セグメント分割間隔: 設定で変更可能（初期値5分、設定範囲1〜10分）
- 最小空き容量の閾値: 設定で変更可能（初期値は運用で定める）
- アップロード先: 設定された自前サーバーURL（接続先は設定で変更可能）

作業情報入力/取得:
- 型式/機番: QRコードから取得
- 工程: Web APIから工程候補を取得し、ユーザーが選択（選択結果は端末内設定として永続化）

補足:
- 保存先パス、ファイル命名規則、URL形式などの具体仕様は基本設計書に記載する

## 9. 受入条件
- UVCカメラ接続後にプレビューが表示される
- プレビュー中にセグメントが生成され、一覧に表示される
- 作業開始/中断/再開/終了により、割当済み/未割当が区別される
- QRコードから型式/機番を取得し、工程をWeb APIから取得して選択できる
- 選択した工程が端末内に保存され、次回起動時に復元される（候補から外れた場合は未選択に戻る）
- 「音声指示」または「作業開始ボタン」で作業開始を確定できる
- 作業開始は「QRコード読み取り」と「作業開始トリガ」が揃った場合にのみ成立する
- 作業中断/再開/終了を「音声指示」または「ボタン」で実行できる
- 別ワークの作業開始が成立した場合、前ワークが自動終了し次ワークが開始する
- 未割当を後追いで作業に紐づけでき、紐づけ後にアップロード対象となる
- 保存済み動画が再生できる（不可の場合もクラッシュせず明示）
- 空き容量が閾値を下回った場合、未割当が古いものから自動削除される
- 空き容量がさらに不足する場合、アップロード済みが古いものから自動削除される
- 未割当削除後も不足する場合、録画停止と通知が行われる
- Wi‑Fi接続時に割当済みセグメントが自動アップロードされ、通信断後も再開できる

