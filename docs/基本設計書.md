# 基本設計書

## 1. 目的
UVC対応USBカメラを使ったプレビュー表示、録画、録画ファイルの再生/削除を行うAndroidアプリの基本設計を定義する。

## 2. 全体構成
### 2.1 アーキテクチャ方針
- UI: Jetpack Compose
- 状態管理: ViewModel + State(Compose)
- UVC制御: `libausbc` (`CameraClient`, `CameraUvcStrategy`) を中心に実装
- 録画ファイル管理: アプリ内Repositoryで一覧/削除を行う
- 再生: Media3 ExoPlayerを想定(要件に合わせて変更可)

### 2.2 主要コンポーネント
- `MainActivity`:
  - 画面遷移のホスト
- `UvcPreviewScreen`:
  - プレビュー表示/録画操作/状態表示
- `RecordingListScreen`:
  - 録画ファイル一覧/再生/削除
- `PlaybackScreen`:
  - 録画ファイルの再生
- `UvcCameraController`:
  - カメラのopen/close、録画開始/停止、USBイベントの受け口
- `RecordingRepository`:
  - 録画ファイルの列挙/削除

## 3. 画面構成/遷移
- メイン(プレビュー)画面
  - プレビュー、録画開始/停止、録画一覧への導線
- 録画一覧画面
  - 録画ファイル一覧、再生/削除ボタン
- 再生画面
  - 動画再生UI(再生/一時停止/シーク)

遷移:
- プレビュー → 一覧 → 再生
- 再生終了で一覧へ戻る

## 4. 機能設計
### 4.1 USB接続/権限
- `CameraUvcStrategy.register()` でUSB attach/detachを監視
- USB許可ダイアログはattach時に自動表示
- `android.permission.CAMERA` は `libausbc` 側の要件に合わせて付与
- 録音機能のため `android.permission.RECORD_AUDIO` を付与
- ストレージ保存はアプリ専用領域を使用し、不要な権限を避ける

### 4.2 プレビュー
- `AspectRatioTextureView` を `AndroidView` で表示
- `openCamera(view)` 実行後、`switchCamera(deviceId)` で対象デバイスを選択
- 画面回転時はアスペクト比を維持

### 4.3 録画
- プレビュー中に録画開始/停止が可能
- `captureVideoStart(callBack, path, durationInSec)` / `captureVideoStop()` を使用
- 映像+音声を含む録画とする
- 録画中は状態インジケータ(録画中/経過時間)を表示
- エラー時は録画停止し、メッセージを表示

### 4.4 録画ファイル一覧
- 保存先ディレクトリをスキャンして一覧を生成
- 表示項目: ファイル名、作成日時、サイズ、再生時間
- ソート: 新しい順

### 4.5 再生
- 一覧からファイルを選択し、再生画面で再生
- 再生/一時停止/シークの基本操作を提供
- 再生中に削除要求があれば停止してから削除

### 4.6 削除
- 削除前に確認ダイアログを表示
- 削除成功後は一覧を更新

### 4.7 エラー処理
- USB切断: プレビュー/録画停止、ユーザー通知
- ストレージ不足: 録画開始不可、または途中停止
- 権限未許可: 画面上にガイダンスを表示

### 4.8 ライフサイクル
- `ON_START`: `register()`、必要に応じてプレビュー再開
- `ON_STOP`: `closeCamera()`、録画停止
- `ON_DESTROY`: `unRegister()`

## 5. データ設計
### 5.1 保存先
- デフォルト: `context.getExternalFilesDir(null)/Movies/UVC`

### 5.2 命名規則
- `uvc_yyyyMMdd_HHmmss.mp4` 形式

### 5.3 録画データモデル(表示用)
- `RecordingItem`
  - `path`: String
  - `name`: String
  - `createdAt`: Long
  - `sizeBytes`: Long
  - `durationMs`: Long

## 6. インタフェース設計(概要)
### 6.1 UvcCameraController
- `open(view: View)`
- `close()`
- `startRecording(path: String)`
- `stopRecording()`
- `setDevice(deviceId: String)`
- `observeUsbEvents()`

### 6.2 RecordingRepository
- `loadRecordings(): List<RecordingItem>`
- `deleteRecording(path: String): Boolean`

## 7. 使用技術/ライブラリ
- `libausbc` / `libuvc`
- Jetpack Compose
- Media3 ExoPlayer(再生)

## 8. 決定事項
- 対応OS: Android 7.0 (API 24) 以上
- 対応解像度/フレームレート: 640x480@30fpsを必須対応、1280x720@30fpsと1920x1080@30fpsに対応（カメラ/端末が対応している場合）
- 録画形式: MP4 (H.264 + AAC)、映像+音声
